<!-- file:///C:/GitHub/AiProjectLangGraph/docs/ai_refactoring_story.html -->
<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Engineering Log: Refining AI Code</title>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap');

    body {
      font-family: 'Pretendard', sans-serif;
      background-color: #ffffff;
      color: #1a1a1a;
      margin: 0;
      padding: 40px;
      display: flex;
      justify-content: center;
    }

    .container {
      width: 1200px;
      max-width: 100%;
      background-color: #ffffff;
      padding: 40px;
    }

    h1 {
      color: #111;
      font-size: 2.4em;
      margin-bottom: 10px;
      border-bottom: 3px solid #111;
      padding-bottom: 15px;
      letter-spacing: -0.5px;
    }

    h2 {
      color: #333;
      font-size: 1.6em;
      margin-top: 50px;
      margin-bottom: 15px;
      font-weight: 800;
      border-left: 5px solid #2962ff;
      padding-left: 15px;
    }

    .subtitle {
      font-size: 1.2em;
      color: #666;
      margin-bottom: 40px;
      font-weight: 500;
    }

    .section-box {
      background-color: #f9f9f9;
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
    }

    /* Problem & Solution Cards */
    .concept-card {
      display: flex;
      gap: 20px;
      margin-bottom: 40px;
    }

    .card-item {
      flex: 1;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .problem-bg {
      background-color: #ffebee;
      border: 1px solid #ffcdd2;
    }

    .solution-bg {
      background-color: #e3f2fd;
      border: 1px solid #bbdefb;
    }

    .card-title {
      font-size: 1.3em;
      font-weight: 800;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
    }

    /* Code Block Styling */
    .code-wrapper {
      background-color: #263238;
      color: #eceff1;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Consolas', monospace;
      font-size: 0.9em;
      line-height: 1.6;
      overflow-x: auto;
      margin-top: 15px;
      position: relative;
    }

    .code-label {
      position: absolute;
      top: 0;
      right: 0;
      background: #37474f;
      color: #fff;
      padding: 4px 10px;
      font-size: 0.8em;
      border-bottom-left-radius: 8px;
    }

    .highlight {
      color: #82b1ff;
      font-weight: bold;
    }

    .comment {
      color: #78909c;
      font-style: italic;
    }

    .error {
      color: #ff8a80;
    }

    .mermaid {
      display: flex;
      justify-content: center;
      background: #fff;
      padding: 20px;
      border: 1px solid #eee;
      border-radius: 10px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Refining AI Code: From "Working" to "Robust"</h1>
    <div class="subtitle">AIê°€ ì‘ì„±í•œ í”„ë¡œí† íƒ€ì… ì½”ë“œë¥¼ ì—”ì§€ë‹ˆì–´ë§ ê´€ì ì—ì„œ <strong>êµ¬ì¡°í™”(Refactoring)</strong>í•˜ê³  <strong>ì•ˆì •ì„±(Stability)</strong>ì„ ë³´ê°•í•œ ê¸°ë¡</div>

    <!-- 1. The Core Philosophy -->
    <div class="concept-card">
      <div class="card-item problem-bg">
        <div class="card-title">ğŸš¨ The Issue (AI Code)</div>
        <p>AIëŠ” ê¸°ëŠ¥ êµ¬í˜„ì— ìµœì í™”ë˜ì–´ ìˆì–´, <strong>ìœ ì§€ë³´ìˆ˜ì„±ê³¼ ì˜ˆì™¸ ìƒí™©(Edge Case)</strong>ì„ ê³ ë ¤í•˜ì§€ ì•ŠëŠ” ê²½í–¥ì´ ìˆìŠµë‹ˆë‹¤.</p>
        <ul style="margin-top:10px; padding-left:20px;">
          <li><strong>Monolithic File:</strong> 500ì¤„ì´ ë„˜ëŠ” í•˜ë‚˜ì˜ íŒŒì¼ì— ëª¨ë“  ë¡œì§ì„ ëª°ì•„ë„£ìŒ.</li>
          <li><strong>Optimistic Coding:</strong> "DB ì—°ê²°ì€ í•­ìƒ ì„±ê³µí•  ê²ƒ"ì´ë¼ëŠ” ê°€ì •í•˜ì— ì˜ˆì™¸ ì²˜ë¦¬ê°€ ì—†ìŒ.</li>
        </ul>
      </div>
      <div class="card-item solution-bg">
        <div class="card-title">ğŸ› ï¸ My Solution (Engineering)</div>
        <p>ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì“°ì§€ ì•Šê³ , <strong>ìš´ì˜ í™˜ê²½ì—ì„œë„ ë²„í‹¸ ìˆ˜ ìˆëŠ” êµ¬ì¡°</strong>ë¡œ ì§ì ‘ ê°œì„ í–ˆìŠµë‹ˆë‹¤.</p>
        <ul style="margin-top:10px; padding-left:20px;">
          <li><strong>Modularization:</strong> ì—­í• (Node) ë‹¨ìœ„ë¡œ íŒŒì¼ì„ ìª¼ê°œì–´ ê°€ë…ì„±ê³¼ ì¬ì‚¬ìš©ì„±ì„ í™•ë³´.</li>
          <li><strong>Robust DB Utils:</strong> íŠ¸ëœì­ì…˜ ê´€ë¦¬(Rollback)ì™€ ë¡œê¹…(Check)ì„ ìœ„í•œ ìœ í‹¸ë¦¬í‹° ì§ì ‘ êµ¬í˜„.</li>
        </ul>
      </div>
    </div>

    <!-- 2. Architecture Diagram -->
    <h2>1. Structural Refactoring (Architecture)</h2>
    <p>ê±°ëŒ€í•œ ë‹¨ì¼ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ì„ LangGraphì˜ ì„¤ê³„ ì² í•™ì— ë§ì¶° <strong>ì±…ì„(Responsibility) ë‹¨ìœ„</strong>ë¡œ ë¶„ë¦¬í–ˆìŠµë‹ˆë‹¤.</p>

    <div class="section-box">
      <div class="mermaid">
        flowchart LR
        subgraph Before ["âŒ Before: Monolithic AI Code"]
        direction TB
        Ag[("ğŸ“„ inquiry_agent.py (500+ lines)")]
        Ag -->|"Contains All Logic"| Search
        Ag -->|"Complex & Mixed"| Sales
        Ag -->|"Hard to Debug"| Answer
        end

        subgraph After ["âœ… After: Modularized Nodes"]
        direction TB
        Main[("ğŸ“‚ agent.py (Wrapper)")]

        subgraph Nodes
        Router["ğŸ”€ router.py"]
        Ret["ğŸ“š retrieval.py"]
        Sale["ğŸ“Š sales.py"]
        Ans["âœï¸ answer.py"]
        end

        Main --> Router
        Router --> Ret
        Router --> Sale
        Ret --> Ans
        Sale --> Ans
        end

        Before -.-> After

        style Before fill:#ffebee,stroke:#ef9a9a,stroke-width:2px
        style After fill:#e3f2fd,stroke:#90caf9,stroke-width:2px
        style Main fill:#2962ff,color:white
      </div>
    </div>

    <!-- 3. Code Refactoring Detail -->
    <h2>2. Reliability Refactoring (DB Stability)</h2>
    <p>AIëŠ” DB ì—°ê²° ì‹¤íŒ¨ë‚˜ ì¿¼ë¦¬ ì˜¤ë¥˜ ì‹œ ì‹œìŠ¤í…œì´ ë©ˆì¶”ëŠ” ì½”ë“œë¥¼ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.<br>
      ì €ëŠ” <strong>`async context manager`</strong>ì™€ <strong>`try-except-rollback`</strong> íŒ¨í„´ì„ ë„ì…í•˜ì—¬ ë°ì´í„° ë¬´ê²°ì„±ì„ ë³´ì¥í–ˆìŠµë‹ˆë‹¤.</p>

    <div class="concept-card">
      <!-- AI Code -->
      <div class="card-item" style="background:#f5f5f5; border:1px solid #ddd;">
        <strong>âŒ AI Code (Unsafe)</strong>
        <div class="code-wrapper" style="margin-top:10px; padding:15px; font-size:0.85em;">
          <span class="error"># ì—ëŸ¬ ì²˜ë¦¬ ì—†ìŒ, íŠ¸ëœì­ì…˜ ê´€ë¦¬ ë¶€ì¬</span>
          async def execute(sql):
          cursor = await conn.cursor()
          await cursor.execute(sql)
          <span class="comment"># ì—¬ê¸°ì„œ ì—ëŸ¬ë‚˜ë©´ ì»¤ë°‹ë„ ë¡¤ë°±ë„ ì•ˆ ë˜ê³  DB Lock ê±¸ë¦¼</span>
          await conn.commit()
        </div>
      </div>

      <!-- My Code -->
      <div class="card-item" style="background:#f0f4c3; border:1px solid #dce775;">
        <strong>âœ… My Refactoring (Safe)</strong>
        <div class="code-wrapper" style="margin-top:10px; padding:15px; font-size:0.85em; background:#263238;">
          <span class="code-label">app/core/db.py</span>
          async def execute(sql, params=()):
          async with pool.connection() as conn:
          <span class="highlight">try:</span>
          async with conn.cursor() as cur:
          await cur.execute(sql, params)
          await conn.commit()
          <span class="highlight">except Exception as e:</span>
          print(f"ğŸ’¥ Query Failed: {e}")
          <span class="highlight">await conn.rollback()</span> <span class="comment"># í•„ìˆ˜!</span>
        </div>
      </div>
    </div>

    <!-- 4. Decorator Logs -->
    <h2>3. Monitoring Utility</h2>
    <p>ë‹¨ìˆœ ê¸°ëŠ¥ êµ¬í˜„ì„ ë„˜ì–´, ì‹œìŠ¤í…œì˜ ë³‘ëª©ì„ ì°¾ê¸° ìœ„í•´ ì‹¤í–‰ ì‹œê°„ì„ ì¸¡ì •í•˜ëŠ” <strong>ë°ì½”ë ˆì´í„°(@Decorator)</strong>ë¥¼ ì§ì ‘ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.</p>

    <div class="section-box">
      <div class="code-wrapper">
        <span class="code-label">app/util/decorators.py</span>
        <span class="highlight">@perform_async_logging</span> <span class="comment"># ì§ì ‘ êµ¬í˜„í•œ ë¡œê¹… ë°ì½”ë ˆì´í„°</span>
        async def run_search_check(store_id, question):
        ...

        <span class="comment">--- [Terminal Output] ---</span>
        ğŸš€ [Start] run_search_check
        âœ… [DB] Query Executed (0.12s)
        ğŸ [End] run_search_check <span class="highlight">(â±ï¸ 1.25s)</span> <span class="comment"># ëŠë¦° êµ¬ê°„ ì‹ë³„ ê°€ëŠ¥</span>
      </div>
    </div>

  </div>

  <script>
    mermaid.initialize({ startOnLoad: true, theme: 'neutral' });
  </script>
</body>

</html>