import asyncio
import os
import sys

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê²½ë¡œ ì¶”ê°€
sys.path.append(os.getcwd())

# OpenAI ì„ë² ë”© ëª¨ë“ˆ ì‚¬ìš©
try:
    from langchain_openai import OpenAIEmbeddings
except ImportError:
    print("âŒ 'langchain-openai' ëª¨ë“ˆì´ ì—†ìŠµë‹ˆë‹¤. 'pip install langchain-openai'ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.")
    sys.exit(1)

from app.core.db import SessionLocal
from app.manual.manual_schema import Manual
from dotenv import load_dotenv

load_dotenv()

# ìƒ˜í”Œ ë°ì´í„° (ë¬¸ì œ ìƒí™© & í•´ê²°ì±…)
MANUAL_DATA = [
    {
        "category": "ì»¤í”¼ í’ˆì§ˆ",
        "title": "ë¼ë–¼ ê±°í’ˆ êº¼ì§ í˜„ìƒ ë° í•´ê²°",
        "content": "í˜„ìƒ: ë¼ë–¼ ê±°í’ˆì´ ì„œë¹™ ì§í›„ ë¹ ë¥´ê²Œ ì‚¬ë¼ì§€ê±°ë‚˜ ê±°ì¹ ì–´ì§.\nì›ì¸: ìŠ¤íŒ€ ì˜¨ë„ê°€ ë„ˆë¬´ ë†’ê±°ë‚˜(70ë„ ì´ìƒ), ê³µê¸° ì£¼ì…ì´ ë¶ˆê· ì¼í•¨.\ní•´ê²°: ìŠ¤íŒ€ ë…¸ì¦ íŒì„ ìš°ìœ  í‘œë©´ì— ì‚´ì§ë§Œ ì ê¸°ê²Œ í•˜ê³ , ë¡¤ë§(íšŒì „)ì„ ì¶©ë¶„íˆ ì£¼ì–´ ë¯¸ì„¸ ê±°í’ˆì„ ë§Œì§. ìš°ìœ  ì˜¨ë„ëŠ” 60~65ë„ê°€ ì ë‹¹í•¨."
    },
    {
        "category": "ì»¤í”¼ í’ˆì§ˆ",
        "title": "ì—ìŠ¤í”„ë ˆì†Œ ì¶”ì¶œ ì†ë„ê°€ ë„ˆë¬´ ë¹ ë¦„ (ê³¼ì†Œ ì¶”ì¶œ)",
        "content": "í˜„ìƒ: ì»¤í”¼ê°€ ë¬¼ì²˜ëŸ¼ ì½¸ì½¸ ìŸì•„ì§€ê³  í¬ë ˆë§ˆê°€ ì–‡ê³  ë°ì€ìƒ‰ì„.\nì›ì¸: ë¶„ì‡„ë„ê°€ ë„ˆë¬´ êµµê±°ë‚˜, ì›ë‘ ì–‘ì´ ì ìŒ, íƒ¬í•‘ì´ ì•½í•¨.\ní•´ê²°: ê·¸ë¼ì¸ë” ë¶„ì‡„ë„ë¥¼ ë” ê³±ê²Œ ì¡°ì ˆ(Fine)í•˜ê±°ë‚˜ ì›ë‘ ë„ì§•ëŸ‰ì„ 1g ëŠ˜ë ¤ë³¼ ê²ƒ. íƒ¬í•‘ ì••ë ¥ì„ ì¼ì •í•˜ê²Œ ìœ ì§€."
    },
    {
        "category": "ê¸°ê¸° ê´€ë¦¬",
        "title": "ë¨¸ì‹  ê·¸ë£¹í—¤ë“œ ë¬¼ ë§‰í˜",
        "content": "í˜„ìƒ: ë²„íŠ¼ì„ ëˆŒëŸ¬ë„ ë¬¼ì´ ê±°ì˜ ì•ˆ ë‚˜ì˜¤ê±°ë‚˜ ì«„ì«„ ë‚˜ì˜´.\nì›ì¸: ì»¤í”¼ ì°Œêº¼ê¸°ë‚˜ ì„íšŒì§ˆë¡œ ì¸í•´ ìŠ¤ì¼€ì¼ì´ ìŒ“ì„.\ní•´ê²°: ì¦‰ì‹œ ë°±í”ŒëŸ¬ì‹±(ì•½í’ˆ ì²­ì†Œ)ì„ 5íšŒ ì‹¤ì‹œ. ê·¸ë˜ë„ ì•ˆ ë˜ë©´ ìƒ¤ì›ŒìŠ¤í¬ë¦°ì„ ë¶„ë¦¬í•˜ì—¬ ì•ˆìª½ì„ ì†”ë¡œ ì²­ì†Œ. ë§¤ì¼ ë§ˆê° ì‹œ ì•½í’ˆ ì²­ì†Œ í•„ìˆ˜."
    },
    {
        "category": "ê³ ê° ì‘ëŒ€(CS)",
        "title": "ìŒë£Œ ì´ë¬¼ì§ˆ ì»´í”Œë ˆì¸ ëŒ€ì‘",
        "content": "ì›ì¹™: 1. ì¦‰ì‹œ ì •ì¤‘íˆ ì‚¬ê³¼(ë³€ëª… ê¸ˆì§€) 2. í•´ë‹¹ ìŒë£Œ ìˆ˜ê±° ë° í™•ì¸ 3. ìƒˆ ìŒë£Œë¡œ ì¦‰ì‹œ êµí™˜ ë˜ëŠ” í™˜ë¶ˆ.\në©˜íŠ¸: 'ì •ë§ ì£„ì†¡í•©ë‹ˆë‹¤, ê³ ê°ë‹˜. ë§ì´ ë†€ë¼ì…¨ì£ ? ë°”ë¡œ í™•ì¸í•˜ê³  ìƒˆê²ƒìœ¼ë¡œ ë‹¤ì‹œ ë§Œë“¤ì–´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.'\ní›„ì†: ì´ë¬¼ì§ˆ ì¢…ë¥˜(ë¨¸ë¦¬ì¹´ë½, ë²Œë ˆ ë“±) ê¸°ë¡ í›„ ë³¸ì‚¬ ë³´ê³ ."
    },
    {
        "category": "ê³ ê° ì‘ëŒ€(CS)",
        "title": "ë§¤ì¥ ë‚´ ì™€ì´íŒŒì´ ì—°ê²° ì•ˆ ë¨",
        "content": "ì¡°ì¹˜: 1. í¬ìŠ¤ê¸° ì˜† ê³µìœ ê¸° ì „ì›ì´ ì¼œì ¸ ìˆëŠ”ì§€ í™•ì¸. 2. ì „ì› ì½”ë“œë¥¼ ëºë‹¤ê°€ 10ì´ˆ í›„ ë‹¤ì‹œ ê¼½ê¸°(ì¬ë¶€íŒ…). 3. ê·¸ë˜ë„ ì•ˆ ë˜ë©´ KT/SKT ì¥ì•  ì ‘ìˆ˜ ë²ˆí˜¸ë¡œ ì „í™”.\nì•ˆë‚´: 'ì£„ì†¡í•©ë‹ˆë‹¤ ê³ ê°ë‹˜, ì§€ê¸ˆ ì¸í„°ë„· ì‹ í˜¸ ì ê²€ ì¤‘ì´ë¼ ì ì‹œ ì—°ê²°ì´ ì–´ë ¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'"
    },
    {
        "category": "ìœ„ìƒ ê´€ë¦¬",
        "title": "ì œë¹™ê¸° ì²­ì†Œ ë° ì†Œë… ì£¼ê¸°",
        "content": "ì£¼ê¸°: í•„í„° ì²­ì†ŒëŠ” ì›” 2íšŒ, ë‚´ë¶€ ì†Œë…ì€ ì›” 1íšŒ í•„ìˆ˜.\në°©ë²•: 1. ì œë¹™ê¸° ì „ì› ë„ê³  ì–¼ìŒ ëª¨ë‘ ë¹„ìš°ê¸°. 2. ì „ìš© ì„¸ì •ì œë¥¼ í¬ì„í•˜ì—¬ ë‚´ë¶€ ë‹¦ê¸°. 3. ë§‘ì€ ë¬¼ë¡œ 3íšŒ ì´ìƒ í—¹êµ¬ê¸°.\nì£¼ì˜: ì„¸ì œ ì”ì—¬ë¬¼ì´ ë‚¨ìœ¼ë©´ ì–¼ìŒì—ì„œ ëƒ„ìƒˆê°€ ë‚  ìˆ˜ ìˆìŒ."
    },
    {
        "category": "ì¬ê³  ê´€ë¦¬",
        "title": "ìš°ìœ  ìœ í†µê¸°í•œ ê´€ë¦¬ë²• (FIFO)",
        "content": "ì›ì¹™: ì„ ì…ì„ ì¶œ(First In First Out). ë¨¼ì € ë“¤ì–´ì˜¨ ìš°ìœ ë¥¼ ì•ìª½ì— ì§„ì—´.\nì²´í¬: ë§¤ì¼ ì˜¤í”ˆ ì‹œ ìš°ìœ  ìœ í†µê¸°í•œ í™•ì¸. ê¸°í•œì´ 1ì¼ ë‚¨ì€ ìš°ìœ ëŠ” ë³„ë„ í‘œì‹œ(ìŠ¤í‹°ì»¤)í•˜ì—¬ ìš°ì„  ì‚¬ìš©.\níê¸°: ìœ í†µê¸°í•œ ì§€ë‚œ ìš°ìœ ëŠ” ì¦‰ì‹œ íê¸°í•˜ê³  ì¥ë¶€ì— ê¸°ë¡ (ì•„ê¹ë‹¤ê³  ì“°ë©´ ì˜ì—…ì •ì§€ ì‚¬ìœ )."
    },
]

async def seed_manuals():
    print("ğŸš€ ë§¤ë‰´ì–¼ ë°ì´í„° ìƒì„± ì‹œì‘ (OpenAI Embeddings)...")
    
    # ì„ë² ë”© ëª¨ë¸ ì´ˆê¸°í™” (OpenAI)
    try:
        # text-embedding-3-small ëª¨ë¸ì´ ê¸°ë³¸ 1536ì°¨ì› ì§€ì› (ê°€ì„±ë¹„ ì¢‹ìŒ)
        embeddings_model = OpenAIEmbeddings(model="text-embedding-3-small")
        print("âœ… OpenAI Embedding ëª¨ë¸ ë¡œë“œ ì™„ë£Œ")
    except Exception as e:
        print(f"âŒ ì„ë² ë”© ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨: {e}")
        print("ğŸ’¡ íŒ: pip install langchain-openai ëª…ë ¹ì–´ë¡œ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í–ˆëŠ”ì§€, .envì— OPENAI_API_KEYê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.")
        return

    db = SessionLocal()
    
    try:
        # ê¸°ì¡´ ë°ì´í„° ì‚­ì œ (ì¤‘ë³µ ë°©ì§€)
        db.query(Manual).delete()
        db.commit()
        print("ğŸ—‘ï¸ ê¸°ì¡´ ë§¤ë‰´ì–¼ ë°ì´í„° ì‚­ì œ ì™„ë£Œ")

        count = 0
        for item in MANUAL_DATA:
            # 1. í…ìŠ¤íŠ¸ í•©ì¹˜ê¸°
            text_to_embed = f"{item['title']}\n{item['content']}"
            
            # 2. ì„ë² ë”© ìƒì„± (API í˜¸ì¶œ)
            vector = embeddings_model.embed_query(text_to_embed)
            
            # 3. DB ì €ì¥
            new_manual = Manual(
                category=item['category'],
                title=item['title'],
                content=item['content'],
                embedding=vector
            )
            db.add(new_manual)
            count += 1
            print(f"   -> [{item['category']}] {item['title']} ì €ì¥ ì¤‘...")
            
        db.commit()
        print(f"âœ… ì´ {count}ê±´ì˜ ë§¤ë‰´ì–¼ ë°ì´í„° ì €ì¥ ì™„ë£Œ!")
        
    except Exception as e:
        print(f"âŒ ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        db.rollback()
    finally:
        db.close()

if __name__ == "__main__":
    asyncio.run(seed_manuals())
